# How to customize Foundation v4.1.0 for Google Cloud VMware Engine (GCVE) Private Cloud deployment

These instructions explain how to deploy the [Google Cloud VMware Engine Private Cloud](https://github.com/GoogleCloudPlatform/gcve-iac-foundations/tree/main/examples/gcve-private-cloud) example on top of the [Terraform Example Foundation](https://cloud.google.com/architecture/security-foundations/using-example-terraform) version [v4.1.0](https://github.com/terraform-google-modules/terraform-example-foundation/tree/v4.1.0).

## Overview

The deploy of the Blueprint will use the `production` environment of the business unit 1
of an existing Terraform Example Foundation and the following infrastructure will be created or reused:

- the Policy Library
- Example Base shared project from Business 1 production
- Base shared VPC from production
- Example peering project from Business 1 production
- CI/CD pipeline from Business 1

## Requirements

### Code

- [terraform-example-foundation](https://github.com/terraform-google-modules/terraform-example-foundation/tree/v4.1.0) version 4.1.0 deployed until at least step `4-projects`.
- You must have role **Service Account User** (`roles/iam.serviceAccountUser`) on the [Terraform Service Accounts](https://github.com/terraform-google-modules/terraform-example-foundation/blob/master/docs/GLOSSARY.md#terraform-service-account) created in the foundation [Seed Project](https://github.com/terraform-google-modules/terraform-example-foundation/blob/master/docs/GLOSSARY.md#seed-project).
  The Terraform Service Accounts have the permissions to deploy each step of the foundation. Service Accounts:
  - `sa-terraform-bootstrap@<SEED_PROJECT_ID>.iam.gserviceaccount.com`.
  - `sa-terraform-env@<SEED_PROJECT_ID>.iam.gserviceaccount.com`
  - `sa-terraform-net@<SEED_PROJECT_ID>.iam.gserviceaccount.com`
  - `sa-terraform-proj@<SEED_PROJECT_ID>.iam.gserviceaccount.com`

Install the following dependencies:

- [Google Cloud SDK](https://cloud.google.com/sdk/install) version 465.0.0 or later.
- [Terraform](https://www.terraform.io/downloads.html) version 1.3.10 or later.
- [jq](https://stedolan.github.io/jq/) version 1.6 or later.

### Cloud SDK configurations

To configured [Application Default Credentials](https://cloud.google.com/sdk/gcloud/reference/auth/application-default) run:

```bash
gcloud auth application-default login
```

## Usage

To deploy the example in the Terraform Example Foundation, you will do updates
in sequence in the configurations of the steps used to the deploy the foundation.


### Directory layout and Terraform initialization

For these instructions we assume that:

- The foundation was deployed using Cloud Build.
- Every repository, excluding the policies repositories, should be on the `production` branch and `terraform init` should be executed in each one.
- The following layout should exists in your local environment since you will need to make changes in these steps.
If you do not have this layout, please checkout the source repositories for the foundation steps following this layout.

    ```text
    gcp-bootstrap
    gcp-environments
    gcp-networks
    gcp-org
    gcp-policies
    gcp-policies-app-infra
    gcp-projects
    terraform-example-foundation
    ```

- Also checkout the [enterprise-gcve-foundation](https://github.com/GoogleCloudPlatform/enterprise-gcve-foundation) repository at the same level.

The final layout should look like this:

    ```text
    enterprise-gcve-foundation
    gcp-bootstrap
    gcp-environments
    gcp-networks
    gcp-org
    gcp-policies
    gcp-policies-app-infra
    gcp-projects
    terraform-example-foundation
    ```

### Update gcloud terraform vet policies

the first step is to update the `gcloud terraform vet` policies constraints to allow usage of the APIs needed by the Blueprint.
The constraints are located in the two policies repositories:

- `gcp-policies`
- `gcp-policies-app-infra`


The API to add is:

```yaml
    - "vmwareengine.googleapis.com"
```

1. The APIs should be included in the `services` list in the file [serviceusage_allow_basic_apis.yaml](https://github.com/terraform-google-modules/terraform-example-foundation/blob/v4.0.0/policy-library/policies/constraints/serviceusage_allow_basic_apis.yaml#L30)
1. Update `gcp-policies/policies/constraints/serviceusage_allow_basic_apis.yaml` file in your policy repository (`gcp-policies`) for the CI/CD pipeline.
1. Commit changes in the `gcp-policies` repository and push the code.

1. Update `gcp-policies-app-infra/policies/constraints/serviceusage_allow_basic_apis.yaml` file in your policy repository (`gcp-policies-app-infra`) for the app infra pipeline.
1. Commit changes in the `gcp-policies-app-infra` repository and push the code.


### 4-projects: Update Infra Pipeline to create a new workspace

Create a new workspace in the business unit 1 shared environment to isolate the resources that
will be deployed in the GCVE example.

1. Update file `gcp-projects/business_unit_1/shared/example_infra_pipeline.tf` to add a new repository in the locals:

    ```hcl
    locals {
      repo_names = ["bu1-example-app", "bu1-gcve"]
    }
    ```

1. Add the `vmwareengine.googleapis.com`, `serviceusage.googleapis.com`, and `monitoring.googleapis.com`  APIs to the list of `activate_apis` in the `app_infra_cloudbuild_project` module:

    ```hcl
      activate_apis = [
        "cloudbuild.googleapis.com",
        "sourcerepo.googleapis.com",
        "cloudkms.googleapis.com",
        "iam.googleapis.com",
        "artifactregistry.googleapis.com",
        "cloudresourcemanager.googleapis.com",
        "vmwareengine.googleapis.com",
        "serviceusage.googleapis.com",
        "monitoring.googleapis.com",
      ]
    ```

1. Commit changes in the `gcp-projects` repository and push the code to the `production` branch.

### 4-projects: Update Roles and APIs

Update Roles and APIs in the project were GCVE will be deployed

1. Update file `gcp-projects/modules/base_env/example_peering_project.tf` to enable APIs and grant roles for the service account created in the previous step for the GCVE workspace.

```
  sa_roles = {
    "${var.business_code}-example-app" = [
        ...
    ],
    "${var.business_code}-gcve" = [
      "roles/compute.instanceAdmin.v1",
      "roles/iam.serviceAccountAdmin",
      "roles/iam.serviceAccountUser",
      "roles/resourcemanager.tagUser",
      "roles/iam.securityAdmin",
      "roles/compute.admin",
      "roles/secretmanager.admin",
      "roles/vmwareengine.vmwareengineAdmin",
      "roles/monitoring.admin",
    ]
  }
```

1. Update the list of APIS to active

```
  activate_apis = [
    "dns.googleapis.com",
    "secretmanager.googleapis.com",
    "serviceusage.googleapis.com",
    "monitoring.googleapis.com",
    "vmwareengine.googleapis.com"
  ]
```

1. Commit changes in the `gcp-projects` repository and push the code to the `production` branch.

### 5-app-infra: Deploy GCVE private

1. Clone the new repo created in step 4-projects/shared:

    ```bash
    terraform -chdir="gcp-projects/business_unit_1/shared/" init
    export INFRA_PIPELINE_PROJECT_ID=$(terraform -chdir="gcp-projects/business_unit_1/shared/" output -raw cloudbuild_project_id)
    echo ${INFRA_PIPELINE_PROJECT_ID}

    gcloud source repos clone bu1-gcve --project=${INFRA_PIPELINE_PROJECT_ID}
    ```

1. Copy the Cloud Build setup and the shared configuration folder:

    ```bash
    cd bu1-gcve
    git checkout -b production

    export sdw_path="../enterprise-gcve-foundation/docs/foundation_deploy/bu1-gcve"

    cp ../terraform-example-foundation/build/cloudbuild-tf-* .
    cp ../terraform-example-foundation/build/tf-wrapper.sh .
    chmod 755 ./tf-wrapper.sh

    cp -RT "${sdw_path}/" .
    mv ./common.auto.example.tfvars ./common.auto.tfvars
    ```

1. Update the build timeout configuration in file `bu1-gcve/cloudbuild-tf-apply.yaml`

Update the build `timeout` from

  ```
  timeout: 3600s # 1 hour
  ```

to

  ```
  timeout: 86400s # 24 hours
  ```

1. Update Region and zone

Edit file `common.auto.tfvars` and update the `region` and `zone` for the deploy of the GCVE Private Cloud

1. Update terraform backend and remote state configuration:

    ```bash
    backend_bucket=$(terraform -chdir="../gcp-projects/business_unit_1/shared" output -json state_buckets | jq '."bu1-gcve"' --raw-output)
    echo "backend_bucket = ${backend_bucket}"

    sed -i "s/UPDATE_APP_INFRA_GCVE_BUCKET/${backend_bucket}/" ./business_unit_1/production/backend.tf

    export remote_state_bucket=$(terraform -chdir="../gcp-bootstrap/envs/shared" output -raw projects_gcs_bucket_tfstate)
    echo "remote_state_bucket = ${remote_state_bucket}"

    sed -i "s/REMOTE_STATE_BUCKET/${remote_state_bucket}/" ./common.auto.tfvars
    ```

1. Commit changes in the `bu1-gcve` repository and push the code to the `production` branch.
1. Wait for the end of Cloud Build build.
1. Check the build execution in `https://console.cloud.google.com/cloud-build/builds;region=<DEFAULT-REGION>?project=<INFRA_PIPELINE_PROJECT_ID>`.
